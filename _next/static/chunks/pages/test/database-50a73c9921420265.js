(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[796],{1651:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>N});var a=t(7876),s=t(4232),o=t(7907),l=t(1930);class n extends l.d{static getInstance(){return n.instance||(n.instance=new n),n.instance}logInfo(e,r){this.enableLog&&console.log("[DatabaseService] ".concat(e),r||"")}logError(e,r){this.enableLog&&console.error("[DatabaseService] ".concat(e),r||"")}getApiBaseUrl(){return window.location.origin}extractError(e){return e.error||e.message||"操作失敗"}validateConnectionConfig(e){if(!e.server)throw Error("伺服器地址不能為空");if(!e.user||!e.password)throw Error("SQL Server 驗證模式需要提供用戶名和密碼")}async testConnection(e){try{this.logInfo("開始測試數據庫連接",{server:e.server,database:e.database||"預設",user:e.user}),this.validateConnectionConfig(e);let r=this.getApiBaseUrl(),t=await fetch("".concat(r,"/api/database/test-connection"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),a=await t.json();if(a.success)return this.logInfo("數據庫連接測試成功",a.message),a;return this.logError("數據庫連接測試失敗",a.message),a}catch(e){return this.logError("數據庫連接測試發生錯誤",e),{success:!1,message:"連接失敗：".concat(e instanceof Error?e.message:"網路錯誤")}}}async executeQuery(e,r,t){try{var a,s;if(this.logInfo("開始執行 SQL 查詢",{query:r.substring(0,100)+"..."}),!r||!r.trim())return{success:!1,error:"SQL 查詢語句不能為空"};let o=this.getApiBaseUrl(),l=await fetch("".concat(o,"/api/database/execute-query"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({config:e,query:r,params:t})}),n=await l.json();if(!n.success)return this.logError("SQL 查詢執行失敗",this.extractError(n)),{success:!1,error:this.extractError(n)};return this.logInfo("SQL 查詢執行成功",{recordCount:(null==(a=n.data)?void 0:a.length)||0}),{success:!0,data:n.data||[],count:(null==(s=n.data)?void 0:s.length)||0,message:n.message}}catch(e){return this.logError("SQL 查詢執行發生錯誤",e),{success:!1,error:"查詢失敗：".concat(e instanceof Error?e.message:"網路錯誤")}}}async getTableList(e){try{this.logInfo("開始獲取數據庫表列表");let r=await this.executeQuery(e,"SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' ORDER BY TABLE_NAME");if(r.success&&r.data){let e=r.data.map(e=>e.TABLE_NAME);return this.logInfo("成功獲取表列表",{tableCount:e.length}),e}{let e=this.extractError(r);if(e.includes("登入失敗"))return this.logError("登入失敗：請檢查使用者名稱、密碼，或確認帳號是否有存取該資料庫的權限。如有疑問請聯絡資料庫管理員。",e),[];return this.logError("獲取表列表失敗",e),[]}}catch(e){return this.logError("獲取表列表失敗",e),[]}}async getTableSchema(e,r){try{this.logInfo("開始獲取表結構",{tableName:r});let t=await this.executeQuery(e,"SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE, COLUMN_DEFAULT, CHARACTER_MAXIMUM_LENGTH, NUMERIC_PRECISION, NUMERIC_SCALE FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = @tableName ORDER BY ORDINAL_POSITION",{tableName:r});if(t.success&&t.data)return this.logInfo("成功獲取表結構",{columnCount:t.data.length}),t.data;throw Error(this.extractError(t))}catch(e){throw this.logError("獲取表結構失敗",e),Error(e instanceof Error?e.message:"獲取表結構失敗")}}async getDatabaseList(e){try{this.logInfo("開始獲取資料庫列表");let r={...e,database:"master"},t=await this.executeQuery(r,"SELECT name FROM sys.databases WHERE database_id > 4 ORDER BY name");if(t.success&&t.data){let e=t.data.map(e=>e.name);return this.logInfo("成功獲取資料庫列表",{databaseCount:e.length}),e}throw Error(this.extractError(t))}catch(e){throw this.logError("獲取資料庫列表失敗",e),Error(e instanceof Error?e.message:"獲取資料庫列表失敗")}}constructor(){super(),this.enableLog=!0}}class c extends o.wp{validateConfig(e){return e.server&&e.user&&e.password?null:"請提供完整的連接資訊：伺服器地址、使用者名稱和密碼"}failResult(e){return{success:!1,message:e,data:[],count:0}}async testConnection(e){try{this.logInfo("開始測試資料庫連接",{server:e.server,user:e.user,database:e.database||"預設"});let r=this.validateConfig(e);if(r)return{success:!1,message:r};let t=await this.databaseService.testConnection(e);return this.logInfo("資料庫連接測試完成",{success:t.success}),t}catch(e){return this.logError("資料庫連接測試失敗",e),{success:!1,message:e instanceof Error?e.message:"資料庫連接測試失敗，請檢查連接設定"}}}async executeQuery(e,r,t){try{if(this.logInfo("開始執行 SQL 查詢",{server:e.server,user:e.user,queryLength:(null==r?void 0:r.length)||0}),!r||!r.trim())return this.failResult("SQL 查詢語句不能為空");let a=await this.databaseService.executeQuery(e,r,t);return this.logInfo("SQL 查詢執行完成",{success:a.success,recordCount:a.count||0}),a}catch(e){return this.logError("SQL 查詢執行失敗",e),this.failResult(e instanceof Error?e.message:"SQL 查詢執行失敗")}}async getTableList(e){try{this.logInfo("開始獲取表列表",{server:e.server,database:e.database});let r=await this.databaseService.getTableList(e);return this.logInfo("獲取表列表完成",{tableCount:r.length}),{success:!0,data:r,count:r.length}}catch(e){return this.logError("獲取表列表失敗",e),this.failResult(e instanceof Error?e.message:"獲取表列表失敗")}}async getTableSchema(e,r){try{if(this.logInfo("開始獲取表結構",{server:e.server,database:e.database,tableName:r}),!r||!r.trim())return this.failResult("表名不能為空");let t=await this.databaseService.getTableSchema(e,r);return this.logInfo("獲取表結構完成",{columnCount:t.length}),{success:!0,data:t,count:t.length}}catch(e){return this.logError("獲取表結構失敗",e),this.failResult(e instanceof Error?e.message:"獲取表結構失敗")}}async getDatabaseList(e){try{this.logInfo("開始獲取資料庫列表",{server:e.server,user:e.user});let r=await this.databaseService.getDatabaseList(e);return this.logInfo("獲取資料庫列表完成",{databaseCount:r.length}),{success:!0,data:r,count:r.length}}catch(e){return this.logError("獲取資料庫列表失敗",e),this.failResult(e instanceof Error?e.message:"獲取資料庫列表失敗")}}constructor(){super(),this.databaseService=n.getInstance()}}var i=t(7377);let d=(0,s.memo)(e=>{let{label:r,type:t="text",value:s,onChange:o,placeholder:l,required:n=!1,...c}=e;return(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[r," ",n&&(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsx)("input",{type:t,value:s,onChange:o,placeholder:l,className:"w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500",...c})]})});d.displayName="InputField";let u=(0,s.memo)(e=>{let{label:r,value:t,onChange:s,showPassword:o,onToggle:l,required:n=!1,...c}=e;return(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[r," ",n&&(0,a.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{type:o?"text":"password",value:t,onChange:s,placeholder:"密碼",className:"w-full px-3 py-2 pr-10 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500",...c}),(0,a.jsx)("button",{type:"button",onClick:l,className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:o?"隱藏":"顯示"})]})]})});u.displayName="PasswordField";let g=(0,s.memo)(e=>{let{databaseList:r,selected:t,onSelect:s}=e;return(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"選擇資料庫"}),(0,a.jsx)("div",{className:"max-h-32 overflow-y-auto border border-gray-200 rounded",children:r.map(e=>(0,a.jsx)("button",{onClick:()=>s(e),className:"w-full text-left px-3 py-2 text-sm border-b border-gray-100 hover:bg-gray-50 ".concat(t===e?"bg-blue-50 text-blue-900":""),children:e},e))})]})});g.displayName="DatabaseList";let h=e=>{let{onLoginSuccess:r}=e,[t,o]=(0,s.useState)({user:"",password:"",server:"localhost",database:"",port:1433,options:{encrypt:!1,trustServerCertificate:!0}}),[l,n]=(0,s.useState)(!1),[h,b]=(0,s.useState)(null),[m,x]=(0,s.useState)([]),y=(0,s.useMemo)(()=>new c,[]),{loading:p,execute:E}=(0,i.aE)(),{loading:v,execute:N}=(0,i.aE)(),f=(0,s.useCallback)(()=>{o({user:"webtest",password:"webtestPass123!",server:"localhost",database:"TEST_DATABASE",port:1433,options:{encrypt:!1,trustServerCertificate:!0}})},[]),S=(0,s.useCallback)(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t;return e.server?!!e.user&&!!e.password||(alert("請填寫使用者名稱和密碼"),!1):(alert("請填寫伺服器地址"),!1)},[t]),w=(0,s.useCallback)(async()=>{let e={...t,database:t.database&&t.database.trim()?t.database:"master"};S(e)&&await E(async()=>{let t=await y.testConnection(e);return b(t),t.success&&setTimeout(()=>{r(e)},1e3),t})},[t,E,r,y,S]),j=(0,s.useCallback)(async()=>t.server?t.user&&t.password?void await N(async()=>{try{let e=await y.getDatabaseList(t);return x(Array.isArray(e.data)?e.data:[]),Array.isArray(e.data)?e.data:[]}catch(r){let e="獲取資料庫列表失敗";throw r&&"object"==typeof r&&"message"in r&&(e="獲取資料庫列表失敗: ".concat(r.message)),alert(e),r}}):void alert("請填寫使用者名稱和密碼"):void alert("請先填寫伺服器地址"),[t,N,y]),T=(0,s.useCallback)(e=>{o(r=>({...r,database:e}))},[]);return(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-6",children:(0,a.jsx)("div",{className:"max-w-md w-full",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg border border-gray-200 p-8 shadow-sm",children:[(0,a.jsxs)("div",{className:"text-center mb-8",children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold text-gray-900 mb-2",children:"資料庫登入"}),(0,a.jsx)("p",{className:"text-gray-600",children:"請輸入您的 SQL Server 連接資訊"})]}),(0,a.jsx)("div",{className:"mb-6 p-3 bg-blue-50 border border-blue-200 rounded",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-blue-900",children:"開發模式"}),(0,a.jsx)("p",{className:"text-xs text-blue-700",children:"快速填入測試登入資訊"})]}),(0,a.jsx)("button",{onClick:f,className:"px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"快速登入"})]})}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,a.jsx)(d,{label:"伺服器地址",required:!0,value:t.server,onChange:e=>o({...t,server:e.target.value}),placeholder:"localhost"}),(0,a.jsx)(d,{label:"連接埠號",type:"number",value:t.port,onChange:e=>o({...t,port:parseInt(e.target.value)||1433}),placeholder:"1433"})]}),(0,a.jsx)(d,{label:"使用者名稱",required:!0,value:t.user||"",onChange:e=>o({...t,user:e.target.value}),placeholder:"SQL Server 帳號"}),(0,a.jsx)(u,{label:"密碼",required:!0,value:t.password||"",onChange:e=>o({...t,password:e.target.value}),showPassword:l,onToggle:()=>n(e=>!e)}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"資料庫名稱 *"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"text",value:t.database||"",onChange:e=>o({...t,database:e.target.value}),placeholder:"資料庫名稱",className:"flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),(0,a.jsx)("button",{onClick:j,disabled:v,className:"px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded disabled:opacity-50",children:v?"...":"\uD83D\uDCCB"})]})]}),m.length>0&&(0,a.jsx)(g,{databaseList:m,selected:t.database||"",onSelect:T}),h&&(0,a.jsx)("div",{className:"p-3 rounded ".concat(h.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:(0,a.jsx)("div",{className:"text-sm ".concat(h.success?"text-green-800":"text-red-800"),children:h.message})}),(0,a.jsx)("button",{onClick:w,disabled:p,className:"w-full bg-blue-600 text-white px-4 py-3 rounded hover:bg-blue-700 disabled:opacity-50 font-medium",children:p?"連接中...":"登入資料庫"})]}),(0,a.jsxs)("div",{className:"mt-6 p-4 bg-gray-50 rounded",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-900 mb-2",children:"連接提示"}),(0,a.jsxs)("ul",{className:"text-xs text-gray-600 space-y-1",children:[(0,a.jsx)("li",{children:"• 確保 SQL Server 服務已啟動"}),(0,a.jsx)("li",{children:"• 預設連接埠號為 1433"}),(0,a.jsx)("li",{children:"• 需要啟用 SQL Server 驗證模式"}),(0,a.jsx)("li",{children:"• 確認帳戶有資料庫連接權限"})]})]})]})})})};class b{static getInstance(){return b.instance||(b.instance=new b),b.instance}async login(e){try{if(await new Promise(e=>setTimeout(e,1e3)),"demo@example.com"===e.email&&"demo123"===e.password){let r={id:"user_001",name:"示範用戶",email:e.email,avatar:"https://example.com/avatar.jpg",role:"user",isVerified:!0,createdAt:"2024-01-01T00:00:00Z",lastLoginAt:new Date().toISOString()},t={accessToken:"mock_token_".concat(Date.now()),refreshToken:"mock_refresh_".concat(Date.now()),expiresIn:3600,tokenType:"Bearer"};return this.currentUser=r,this.token=t.accessToken,this.saveAuthToStorage(r,t.accessToken),{user:r,token:t}}throw Error("帳號或密碼錯誤")}catch(e){throw console.error("Login error:",e),e}}async register(e){try{if(await new Promise(e=>setTimeout(e,1500)),e.password!==e.confirmPassword)throw Error("密碼確認不相符");if(!e.agreeToTerms)throw Error("請同意服務條款");let r={id:"user_".concat(Date.now()),name:e.name,email:e.email,role:"user",isVerified:!1,createdAt:new Date().toISOString()},t={accessToken:"mock_token_".concat(Date.now()),refreshToken:"mock_refresh_".concat(Date.now()),expiresIn:3600,tokenType:"Bearer"};return this.currentUser=r,this.token=t.accessToken,this.saveAuthToStorage(r,t.accessToken),{user:r,token:t}}catch(e){throw console.error("Registration error:",e),e}}async logout(){try{await new Promise(e=>setTimeout(e,500)),this.currentUser=null,this.token=null,this.clearAuthFromStorage()}catch(e){throw console.error("Logout error:",e),e}}async refreshToken(){try{await new Promise(e=>setTimeout(e,300));let e={accessToken:"mock_token_".concat(Date.now()),refreshToken:"mock_refresh_".concat(Date.now()),expiresIn:3600,tokenType:"Bearer"};return this.token=e.accessToken,this.currentUser&&this.saveAuthToStorage(this.currentUser,e.accessToken),e}catch(e){throw console.error("Token refresh error:",e),e}}async resetPassword(e){try{await new Promise(e=>setTimeout(e,1e3)),console.log("Password reset email sent to: ".concat(e.email))}catch(e){throw console.error("Reset password error:",e),e}}async changePassword(e){try{if(await new Promise(e=>setTimeout(e,800)),e.newPassword!==e.confirmPassword)throw Error("新密碼確認不相符");console.log("Password changed successfully")}catch(e){throw console.error("Change password error:",e),e}}async verifyEmail(){try{await new Promise(e=>setTimeout(e,500)),this.currentUser&&(this.currentUser.isVerified=!0,this.saveAuthToStorage(this.currentUser,this.token))}catch(e){throw console.error("Email verification error:",e),e}}async resendVerificationEmail(){try{await new Promise(e=>setTimeout(e,300)),console.log("Verification email sent")}catch(e){throw console.error("Resend verification error:",e),e}}getCurrentUser(){return this.currentUser}getToken(){return this.token}isAuthenticated(){return null!==this.currentUser&&null!==this.token}isAdmin(){var e;return(null==(e=this.currentUser)?void 0:e.role)==="admin"}isAnalyst(){var e,r;return(null==(e=this.currentUser)?void 0:e.role)==="analyst"||(null==(r=this.currentUser)?void 0:r.role)==="admin"}saveAuthToStorage(e,r){try{localStorage.setItem("auth_user",JSON.stringify(e)),localStorage.setItem("auth_token",r)}catch(e){console.error("Error saving auth to storage:",e)}}loadAuthFromStorage(){try{{let e=localStorage.getItem("auth_user"),r=localStorage.getItem("auth_token");e&&r&&(this.currentUser=JSON.parse(e),this.token=r)}}catch(e){console.error("Error loading auth from storage:",e),this.clearAuthFromStorage()}}clearAuthFromStorage(){try{localStorage.removeItem("auth_user"),localStorage.removeItem("auth_token")}catch(e){console.error("Error clearing auth from storage:",e)}}getAuthHeaders(){let e={"Content-Type":"application/json"};return this.token&&(e.Authorization="Bearer ".concat(this.token)),e}constructor(){this.currentUser=null,this.token=null,this.loadAuthFromStorage()}}let m=[{label:"系統表",query:"SELECT TOP 10 *\nFROM sys.tables",category:"system",color:"bg-gray-100 hover:bg-gray-200 text-gray-700"},{label:"資料庫",query:"SELECT name\nFROM sys.databases",category:"system",color:"bg-gray-100 hover:bg-gray-200 text-gray-700"},{label:"查詢最新",query:"SELECT TOP 100 *\nFROM stock_data_1D\nWHERE symbol = 'AAPL' ORDER BY datetime DESC;",category:"query",color:"bg-blue-100 hover:bg-blue-200 text-blue-700"},{label:"RSI 比較",query:"SELECT TOP 100 symbol, datetime, rsi_14, close_price\nFROM stock_data_1D\nWHERE datetime = (SELECT MAX(datetime) FROM stock_data_1D)\nORDER BY datetime DESC, symbol;",category:"analysis",color:"bg-purple-100 hover:bg-purple-200 text-purple-700"},{label:"日期範圍",query:"SELECT TOP 100 *\nFROM stock_data_1H\nWHERE datetime BETWEEN '2025-06-20T09:00:00' AND '2025-12-31'\nORDER BY datetime ASC;",category:"query",color:"bg-blue-100 hover:bg-blue-200 text-blue-700"},{label:"特定股票",query:"SELECT TOP 100 *\nFROM stock_data_1D\nWHERE symbol = 'AAPL'\nORDER BY datetime DESC;",category:"query",color:"bg-blue-100 hover:bg-blue-200 text-blue-700"},{label:"技術指標異常",query:"SELECT SYMBOL, DATETIME, OPEN_PRICE, HIGH_PRICE, LOW_PRICE, CLOSE_PRICE, VOLUME, RSI_14\nFROM stock_data_1D\nWHERE datetime = (SELECT MAX(datetime) FROM stock_data_1D) AND (rsi_14 < 30 OR rsi_14 > 70)\nORDER BY datetime DESC;",category:"analysis",color:"bg-purple-100 hover:bg-purple-200 text-purple-700"},{label:"統計股票數量",query:"SELECT symbol, COUNT(*) as record_count\nFROM stock_data_1D\nGROUP BY symbol\nORDER BY symbol ASC;",category:"stats",color:"bg-green-100 hover:bg-green-200 text-green-700"},{label:"⚠️ 修改數據",query:"-- 危險操作 --\nUPDATE TABLE_NAME\nSET open_price='0.00', high_price='0.00', low_price='0.00', close_price='0.00', volume='0'\nWHERE id = 0",category:"danger",color:"bg-red-100 hover:bg-red-200 text-red-700 border-red-300"},{label:"⚠️ 新增數據",query:"-- 危險操作 --\nINSERT INTO TABLE_NAME (symbol, datetime, open_price, high_price, low_price, close_price, volume)\nVALUES ('SYMBOL', '2030-01-01T00:00:00', '0.00', '0.00', '0.00', '0.00', '0');",category:"danger",color:"bg-red-100 hover:bg-red-200 text-red-700 border-red-300"},{label:"⚠️ 刪除數據",query:"-- 危險操作 --\nDELETE FROM TABLE_NAME\nWHERE id = 0",category:"danger",color:"bg-red-100 hover:bg-red-200 text-red-700 border-red-300"},{label:"⚠️ 新增資料表",query:"-- 危險操作 --\nCREATE TABLE TABLE_NAME (\n  id INT PRIMARY KEY,\n  symbol VARCHAR(10),\n  datetime DATETIME,\n  open_price DECIMAL(10, 2),\n  high_price DECIMAL(10, 2),\n  low_price DECIMAL(10, 2),\n  close_price DECIMAL(10, 2),\n  volume INT\n);",category:"danger",color:"bg-red-100 hover:bg-red-200 text-red-700 border-red-300"},{label:"⚠️ 清空資料表",query:"-- 危險操作 --\nTRUNCATE TABLE TABLE_NAME",category:"danger",color:"bg-red-100 hover:bg-red-200 text-red-700 border-red-300"},{label:"⚠️ 刪除資料表",query:"-- 危險操作 --\nDROP TABLE IF EXISTS TABLE_NAME",category:"danger",color:"bg-red-100 hover:bg-red-200 text-red-700 border-red-300"},{label:"⚠️ 新增資料庫",query:"-- 危險操作 --\nCREATE DATABASE DATABASE_NAME;",category:"danger",color:"bg-red-100 hover:bg-red-200 text-red-700 border-red-300"},{label:"⚠️ 刪除資料庫",query:"-- 危險操作 --\nDROP DATABASE IF EXISTS DATABASE_NAME",category:"danger",color:"bg-red-100 hover:bg-red-200 text-red-700 border-red-300"},{label:"統計資料表大小",query:"SELECT t.name AS table_name,\n       SUM(p.rows) AS row_count,\n       SUM(a.total_pages) * 8 AS total_size_kb,\n       SUM(a.used_pages) * 8 AS used_size_kb,\n       (SUM(a.total_pages) - SUM(a.used_pages)) * 8 AS unused_size_kb\nFROM sys.tables t\nINNER JOIN sys.indexes i ON t.object_id = i.object_id\nINNER JOIN sys.partitions p ON i.object_id = p.object_id AND i.index_id = p.index_id\nINNER JOIN sys.allocation_units a ON p.partition_id = a.container_id\nWHERE t.is_ms_shipped = 0 AND i.type <= 1\nGROUP BY t.name\nORDER BY total_size_kb DESC;",category:"stats",color:"bg-green-100 hover:bg-green-200 text-green-700"},{label:"查詢資料庫大小",query:"SELECT DB_NAME(database_id) AS DatabaseName,\n       Name AS Logical_Name,\n       type_desc,\n       Physical_Name,\n       size * 8 / 1024 AS size_mb,\n       (size - FILEPROPERTY(name, 'SpaceUsed')) * 8 / 1024 AS free_space_mb\nFROM sys.master_files\nORDER BY size_mb DESC;",category:"stats",color:"bg-green-100 hover:bg-green-200 text-green-700"},{label:"查詢資料庫屬性",query:"select  * from sys.database_files",category:"stats",color:"bg-green-100 hover:bg-green-200 text-green-700"}],x=(0,s.memo)(e=>{let{templates:r,onSelect:t}=e;return(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:r.map(e=>(0,a.jsx)("button",{type:"button",className:"px-3 py-1 rounded text-xs font-medium border ".concat(e.color),onClick:()=>t(e.query),children:e.label},e.label))})});x.displayName="QueryTemplates";let y=(0,s.memo)(e=>{let{tables:r,selected:t,onSelect:s}=e;return(0,a.jsx)("div",{className:"max-h-80 overflow-y-auto space-y-1",children:r.map(e=>(0,a.jsx)("button",{onClick:()=>s(e),className:"w-full text-left px-3 py-2 rounded border border-gray-100 hover:bg-blue-50 ".concat(t===e?"bg-blue-100 font-bold":""),children:e},e))})});y.displayName="TableList";let p=(0,s.memo)(e=>{let{data:r}=e;if(!r||0===r.length)return(0,a.jsx)("div",{className:"text-center py-8 text-gray-500",children:"暫無數據"});let t=Object.keys(r[0]);return(0,a.jsxs)("div",{className:"overflow-x-auto border border-gray-200 rounded-lg",children:[(0,a.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,a.jsx)("thead",{className:"bg-gray-50",children:(0,a.jsx)("tr",{children:t.map(e=>(0,a.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:e},e))})}),(0,a.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:r.slice(0,100).map((e,r)=>(0,a.jsx)("tr",{className:r%2==0?"bg-white":"bg-gray-50",children:t.map(r=>(0,a.jsx)("td",{className:"px-4 py-3 text-sm text-gray-900",children:null===e[r]?(0,a.jsx)("span",{className:"text-gray-400 italic",children:"NULL"}):"boolean"==typeof e[r]?(0,a.jsx)("span",{className:e[r]?"text-green-600":"text-red-600",children:e[r]?"TRUE":"FALSE"}):String(e[r])},r))},r))})]}),r.length>100&&(0,a.jsxs)("div",{className:"bg-gray-50 px-4 py-2 text-sm text-gray-600 border-t",children:["顯示前 100 筆記錄，總共 ",r.length," 筆"]})]})});p.displayName="ResultTable";let E=e=>{var r,t,o;let{config:l,onLogout:n}=e,d={...l,database:l.database&&l.database.trim()?l.database:"master"},[u,g]=(0,s.useState)("SELECT TOP 10 * FROM sys.tables"),[h,E]=(0,s.useState)([]),[v,N]=(0,s.useState)(""),[,f]=(0,s.useState)(!1),[S,w]=(0,s.useState)([]),[j,T]=(0,s.useState)(d),[A,_]=(0,s.useState)(1),C=b.getInstance().getCurrentUser(),L=(0,s.useMemo)(()=>new c,[]),{data:R,loading:k,error:O,execute:I}=(0,i.aE)(),{loading:M,execute:D,error:P}=(0,i.aE)(),B=(0,s.useCallback)(async()=>{if(!u.trim())return void alert("請輸入 SQL 查詢語句");_(1),await I(async()=>{let e=await L.executeQuery(j,u.trim());return{...e,data:Array.isArray(e.data)?e.data:[]}})},[u,j,I,L]);s.useEffect(()=>{D(async()=>{let e=await L.getTableList(j);return E(Array.isArray(e.data)?e.data:[]),Array.isArray(e.data)?e.data:[]})},[j,D,L]);let U=(0,s.useCallback)(async()=>{await D(async()=>{let e=await L.getTableList(j);return E(Array.isArray(e.data)?e.data:[]),Array.isArray(e.data)?e.data:[]})},[j,D,L]),F=(0,s.useCallback)(e=>{N(e),_(1),g(r=>{if(!r.trim()||/^SELECT TOP 10 \* FROM \[?.*\]?$/i.test(r.trim()))return"SELECT TOP 10 * FROM [".concat(e,"]");let t=/FROM\s+\[?([\w.]+)\]?/i;if(t.test(r))return r.replace(t,"FROM [".concat(e,"]"));let a=r.match(/(SELECT[\s\S]*?)(WHERE|ORDER BY|GROUP BY|$)/i);if(a){let[t]=a;return r.replace(t,"".concat(t," FROM [").concat(e,"] "))}return"SELECT TOP 10 * FROM [".concat(e,"]")})},[]),q=(0,s.useCallback)(e=>{g(e)},[]),Q=(0,s.useCallback)(async()=>{try{let e=await L.getDatabaseList(j);w(Array.isArray(e.data)?e.data:[]),f(!0)}catch(e){alert("獲取資料庫列表失敗")}},[j,L]),Y=(0,s.useCallback)(e=>{T(r=>({...r,database:e||"master"})),f(!1),E([]),N(""),g("SELECT TOP 10 * FROM sys.tables")},[]),H=s.useMemo(()=>{if(!(null==R?void 0:R.data))return[];let e=(A-1)*25;return R.data.slice(e,e+25)},[R,A,25]),W=(null==R||null==(r=R.data)?void 0:r.length)||0,z=Math.ceil(W/25)||1;return(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 p-4",children:(0,a.jsxs)("div",{className:"max-w-7xl mx-auto space-y-6",children:[(0,a.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"SQL Server 資料庫管理"}),(0,a.jsxs)("div",{className:"mt-2 space-y-1",children:[(0,a.jsxs)("p",{className:"text-gray-600",children:["已連接到: ",j.server,":",j.port," /"," ",j.database]}),(0,a.jsxs)("div",{className:"flex items-center space-x-4 text-sm",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"text-gray-500",children:"資料庫帳號:"}),(0,a.jsx)("span",{className:"font-medium text-blue-600",children:j.user})]}),C&&(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"text-gray-500",children:"登入用戶:"}),(0,a.jsx)("span",{className:"font-medium text-green-600",children:C.name}),(0,a.jsxs)("span",{className:"text-gray-400",children:["(",C.email,")"]})]})]})]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{onClick:U,disabled:M,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 w-36",children:M?"載入中...":"重新載入資料表"}),(0,a.jsx)("button",{onClick:n,className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"登出"})]})]})}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[(0,a.jsx)("div",{className:"lg:col-span-3",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"SQL 查詢"}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"快速模板"}),(0,a.jsx)(x,{templates:m,onSelect:q})]}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"SQL 語句"}),(0,a.jsx)("textarea",{value:u,onChange:e=>g(e.target.value),placeholder:"輸入 SQL 查詢語句...",rows:6,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"})]}),(0,a.jsx)("button",{onClick:B,disabled:k,className:"w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50 font-medium",children:k?"執行中...":"執行查詢"})]})}),(0,a.jsx)("div",{children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-4",children:[(0,a.jsxs)("div",{className:"mb-3",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,a.jsx)("span",{className:"text-xs text-gray-500",children:"目前資料庫："}),(0,a.jsx)("span",{className:"font-semibold text-blue-700",children:j.database}),(0,a.jsx)("button",{onClick:Q,className:"ml-2 px-2 py-1 text-xs bg-yellow-100 hover:bg-yellow-200 rounded border border-yellow-300 text-yellow-800",children:"變更"})]}),S.length>0&&(0,a.jsx)("div",{className:"flex flex-wrap gap-2 mt-1",children:S.map(e=>(0,a.jsx)("button",{onClick:()=>Y(e),className:"px-2 py-1 rounded text-xs border ".concat(j.database===e?"bg-blue-100 border-blue-400 font-bold":"bg-gray-50 border-gray-200"),children:e},e))})]}),(0,a.jsxs)("h3",{className:"text-sm font-medium text-gray-900 mb-3",children:["資料表列表 (",h.length,")"]}),P&&(0,a.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded p-2 mb-2 text-red-700 text-xs",children:["載入資料表失敗：",P]}),0===h.length?(0,a.jsx)("div",{className:"text-center py-4 text-gray-400",children:"尚未載入"}):(0,a.jsx)(y,{tables:h,selected:v,onSelect:F})]})})]}),(R||k||O)&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"查詢結果"}),k?(0,a.jsx)("div",{className:"text-center py-8",children:(0,a.jsx)("div",{className:"text-gray-500",children:"正在執行查詢..."})}):O?(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 rounded p-4",children:(0,a.jsxs)("div",{className:"text-red-800 text-sm",children:["查詢失敗: ",O]})}):(null==R?void 0:R.success)?(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"bg-green-50 border border-green-200 rounded p-3 mb-4",children:(0,a.jsxs)("div",{className:"text-green-800 text-sm",children:["查詢成功，返回 ",null!=(o=null==(t=R.data)?void 0:t.length)?o:0," 筆記錄",R.executionTime&&(0,a.jsxs)("span",{className:"ml-2",children:["・執行時間: ",R.executionTime,"ms"]})]})}),(0,a.jsx)(p,{data:H}),W>25&&(0,a.jsxs)("div",{className:"flex justify-center items-center gap-2 mt-4",children:[(0,a.jsx)("button",{className:"px-2 py-1 rounded border text-xs bg-gray-100 hover:bg-gray-200 disabled:opacity-50",onClick:()=>_(1),disabled:1===A,children:"首頁"}),(0,a.jsx)("button",{className:"px-2 py-1 rounded border text-xs bg-gray-100 hover:bg-gray-200 disabled:opacity-50",onClick:()=>_(e=>Math.max(1,e-1)),disabled:1===A,children:"上一頁"}),(0,a.jsxs)("span",{className:"text-xs text-gray-600",children:["第 ",A," / ",z," 頁"]}),(0,a.jsx)("button",{className:"px-2 py-1 rounded border text-xs bg-gray-100 hover:bg-gray-200 disabled:opacity-50",onClick:()=>_(e=>Math.min(z,e+1)),disabled:A===z,children:"下一頁"}),(0,a.jsx)("button",{className:"px-2 py-1 rounded border text-xs bg-gray-100 hover:bg-gray-200 disabled:opacity-50",onClick:()=>_(z),disabled:A===z,children:"末頁"})]})]}):R?(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 rounded p-4",children:(0,a.jsx)("div",{className:"text-red-800 text-sm",children:R.error||R.message||"查詢失敗: 未知錯誤"})}):null]})]})})},v=()=>{let[e,r]=(0,s.useState)(!1),[t,o]=(0,s.useState)(null),l=(0,s.useCallback)(e=>{o(e),r(!0)},[]),n=(0,s.useCallback)(()=>{r(!1),o(null)},[]);return e&&t?(0,a.jsx)(E,{config:t,onLogout:n}):(0,a.jsx)(h,{onLoginSuccess:l})},N=()=>(0,a.jsx)(v,{})},9060:(e,r,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/test/database",function(){return t(1651)}])}},e=>{var r=r=>e(e.s=r);e.O(0,[636,593,792],()=>r(9060)),_N_E=e.O()}]);